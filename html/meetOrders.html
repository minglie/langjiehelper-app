<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,width=device-width,initial-scale=1.0"/>
    <meta name="format-detection" content="telephone=no,email=no,date=no,address=no">
    <title>meetOrder</title>
    <link rel="stylesheet" type="text/css" href="../css/iconfont/iconfont.css"/>
    <link rel="stylesheet" type="text/css" href="../css/aui.css"/>
    <link rel="stylesheet" type="text/css" href="../css/aui-pull-refresh.css" />
    <link rel="stylesheet" type="text/css" href="../css/contacts_no.css"/>
    <style>
        .aui-active {
            color: #6ab494!important;
            border-bottom-color: #6ab494!important;
        }
    </style>
</head>
<body>
    <div style="width: 100%;height: 45px; background: #f5f5f5;position:fixed;top: 0px; z-index: 99999;">
        <div class="aui-tab" id="tab">
            <div class="aui-tab-item" tapmode onclick="openOrderFrame(2, this);" style="height: 100%; font-size: 16px; color: #323237;">电话</div>
            <div class="aui-tab-item aui-active" tapmode onclick="openOrderFrame(1, this);" style="height: 100%; font-size: 16px; color: #323237;">见面</div>
            <div class="aui-tab-item" tapmode onclick="openOrderFrame(3, this);" style="height: 100%; font-size: 16px; color: #323237;">候补</div>
        </div>
        <div class="aui-searchbar" id="search">
            <div class="aui-searchbar-input aui-border-radius">
                <i class="iconfont icon-search"></i>
                <input type="search" placeholder="请输入搜索内容" id="search-input">
                <div class="aui-searchbar-clear-btn">
                    <i class="iconfont icon-close"></i>
                </div>
            </div>
            <div class="aui-searchbar-btn" tapmode>取消</div>
        </div>
    </div>
    <div class="aui-refresh-content" style="margin-top: 90px;">
        <div class="aui-content">
            <div class="aui-content aui-margin-b-15">
                <ul class="aui-list aui-media-list">

                </ul>
            </div>
        </div>
    </div>
</body>
<script type="text/javascript" src="script/api.js"></script>
<script type="text/javascript" src="../script/jquery.min.js"></script>
<script src="../script/aui-pull-refresh.js"></script>
<script type="text/javascript" src="../script/aui-dialog.js" ></script>
<script type="text/javascript" src="../script/common.js"></script>
<script type="text/javascript" src="../script/aui-popup-new.js"></script>
<script type="text/javascript" src="../script/aui-scroll.js"></script>
<script type="text/javascript">

var popup,default_start_time,isToBottom = true;
var keywords = '',filter = '',page = 1,num = 10;

/**
 * 初始化操作
 */
apiReady(function(){
    popup = new auiPopup();
    api.addEventListener({
        name:'scrolltobottom',
        extra:{
            threshold: 10    //设置距离底部多少距离时触发，默认值为0，数字类型
        }
    }, function(ret, err){
        getList();
    });
    triggerCheckLogin();

    api.addEventListener({
        name: 'meetOrders'
    }, function(ret, err) {
        page = 1;
        keywords = '';
        default_start_time = null;
        $('#search-input').val('');
        $('.aui-media-list').html('');
        triggerCheckLogin();
    });
});

function triggerCheckLogin(){
    checkLogin(function(){
        init();
    });
}

/**
 * 刷新
 */
apiRefresh(function(){
    originState();
});

function originState() {
    page = 1;
    keywords = '';
    default_start_time = null;
    $('#search-input').val('');
    $('.aui-media-list').html('');
    triggerCheckLogin();
}

/**
 * 请求列表数据
 */
function init(){
    if(!localStorage.getItem('username')) return;
    apiAjax({
        url: '/hybrid/meetOrder',
        data: {
            user_id: localStorage.getItem('user_id'),
            page: page,
            pageSize: num,
            keywords: keywords,
        }
    },function(result){
        isToBottom = true;
        if(result.data[0]==null){
            if(page==1){
                $('.aui-media-list').html('');
            }else{
                page--;
            }
            api.toast({
                msg: '没有更多了'
            });
        }else{
            render(result.data);
        }
    });
}

/**
 * 渲染列表
 */
function render(data){
    if(page==1){
        $('.aui-media-list').html('');
    }
    var str = '';
    for (var i = 0; i < data.length; i++) {
        if(default_start_time!=dateTime(data[i].create_time)){
            default_start_time = dateTime(data[i].create_time);
            str += '<li class="aui-list-header date_line">'+dateTime(data[i].create_time)+'</li>';
        }
        var content = data[i].content?data[i].content:'';
        var purpose = data[i].purpose?data[i].purpose:'';
        str += '<li class="aui-list-item aui-list-item-middle" tapmode data-id="'+data[i].id+'" data-company="'+data[i].company+'" onclick="orderInfo(this);">'+
                    '<div class="aui-media-list-item-inner">'+
                        '<div class="aui-list-item-inner aui-list-item-arrow">'+
                            '<div class="aui-list-item-text">'+data[i].company+
                                '<div class="aui-list-item-right">'+data[i].contact_name+'</div>'+
                            '</div>'+
                            '<div class="aui-list-item-text">'+
                                '<div class="orderPurpose" style="width: 200px;min-height: 26px;overflow: hidden;white-space: nowrap;text-overflow: ellipsis;">'+purpose+'</div>'+
                                '<div class="aui-list-item-right" orderState">'+stateColor(data[i].state)+'</div>'+
                            '</div>'+
                        '</div>'+
                    '</div>'+
                '</li>';
    }
    if(page==1){
        $('.aui-media-list').html(str);
    }else{
        $('.aui-media-list').append(str);
    }
    api.parseTapmode();
}

function stateColor(state) {
    if (state == 12) {
        return '<span style="color: #00C853">已通过</span>';
    } else if (state == 9) {
        return '<span style="color: #f00">不同意</span>';
    } else if (state == 6) {
        return '<span style="color: #ffc107 ">审核中</span>';
    } else if (state == 3) {
        return '<span style="color: #03a9f4 ">反馈中</span>';
    }
    return '填报中';
}

/**
 * 跳转到指定联系单
 */
function orderInfo(obj){
    var id = $(obj).attr('data-id');
    var company = $(obj).attr('data-company');
    api.openWin({
        name: 'meet_order_info',
        url: '../html/meet_order_info_win.html',
        pageParam: {
            id: id,
            company: company
        }
    });
}

/**
 * 获取数据
 */
function getList(){
    if(isToBottom){
        isToBottom = false;
        page++;
        init();
    }
}

function updateItem(id, purpose, state) {
    $('.aui-list-item').each(function(){
        var domId = $(this).attr('data-id');
        if (domId == id) {
            $(this).find('.orderPurpose').text(purpose);
            $(this).find('.orderState').html(stateColor(state));
        }
    });
}

/**
 * 搜索界面功能初始化
 */
var searchBar = document.querySelector(".aui-searchbar");
var searchBarInput = document.querySelector(".aui-searchbar input");
var searchBarBtn = document.querySelector(".aui-searchbar .aui-searchbar-btn");
var searchBarClearBtn = document.querySelector(".aui-searchbar .aui-searchbar-clear-btn");
if(searchBar){
    searchBarInput.onclick = function(){
        searchBarBtn.style.marginRight = 0;
    }
    searchBarInput.oninput = function(){
        if(this.value.length){
            searchBarClearBtn.style.display = 'block';
            searchBarBtn.classList.add("aui-text-info");
            searchBarBtn.textContent = "搜索";
        }else{
            searchBarClearBtn.style.display = 'none';
            searchBarBtn.classList.remove("aui-text-info");
            searchBarBtn.textContent = "取消";
        }
    }
}
searchBarClearBtn.onclick = function(){
    this.style.display = 'none';
    searchBarInput.value = '';
    searchBarBtn.classList.remove("aui-text-info");
    searchBarBtn.textContent = "取消";
}
searchBarBtn.onclick = function(){
    keywords = searchBarInput.value;
    if(keywords.length){
        searchBarInput.blur();
        default_start_time = null;
        page = 1;
        init();
    }else{
        this.style.marginRight = "-"+this.offsetWidth+"px";
        searchBarInput.value = '';
        searchBarInput.blur();
    }
}

</script>
</html>
